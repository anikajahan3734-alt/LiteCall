<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Video Call & Voice</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; text-align: center; margin: 0; padding-bottom: 20px; }
        .v-container { width: 100%; height: 35vh; background: #111; position: relative; border-bottom: 2px solid #333; }
        #remote-v { width: 100%; height: 100%; object-fit: contain; }
        #local-v { width: 60px; height: 60px; position: absolute; bottom: 5px; right: 5px; border: 1px solid #0f0; background: #000; }
        .ui-box { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        input, button { padding: 12px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; }
        input { background: #222; color: #fff; text-align: center; grid-column: span 2; border: 1px solid #444; }
        .call { background: #28a745; color: #fff; }
        .end { background: #dc3545; color: #fff; }
        .voice { background: #ffc107; color: #000; grid-column: span 2; } 
        .file { background: #007bff; color: #fff; grid-column: span 2; }
        #my-id { color: #ffeb3b; font-size: 22px; font-weight: bold; margin: 10px 0; }
        #status-msg { color: #00ffff; font-size: 14px; margin: 5px; }
    </style>
</head>
<body>

    <div class="v-container">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline></video>
    </div>

    <div id="my-id">ID তৈরি হচ্ছে...</div>
    <div id="status-msg">ক্যামেরা লোড হচ্ছে...</div>

    <div class="ui-box">
        <input type="number" id="target-id" placeholder="বন্ধুর ৪ সংখ্যার ID দিন">
        <button class="call" onclick="makeCall()">কল দিন</button>
        <button class="end" onclick="endCall()">কাটুন</button>
        
        <button id="voice-btn" class="voice">ভয়েস রেকর্ড (টিপে ধরুন)</button>
        
        <input type="file" id="f-input" style="display:none" onchange="sendFile(this.files[0])">
        <button class="file" onclick="document.getElementById('f-input').click()">ফাইল বা ভিডিও পাঠান</button>
    </div>

    <script>
        const remoteV = document.getElementById('remote-v');
        const localV = document.getElementById('local-v');
        const myIdEl = document.getElementById('my-id');
        const statusMsg = document.getElementById('status-msg');
        const voiceBtn = document.getElementById('voice-btn');
        
        // ৪ সংখ্যার সহজ আইডি
        const shortId = Math.floor(1000 + Math.random() * 9000).toString();
        let peer = new Peer(shortId); 
        let localStream, currentCall, dataConn, mediaRecorder, audioChunks = [];

        // বাটন ফোনের জন্য লো-রেজুলেশন সেটিংস
        const constraints = { video: { width: 160, height: 120, frameRate: 10 }, audio: true };

        navigator.mediaDevices.getUserMedia(constraints).then(stream => {
            localStream = stream;
            localV.srcObject = stream;
            statusMsg.innerText = "ক্যামেরা প্রস্তুত";
            
            // ভয়েস রেকর্ডিং ইঞ্জিন
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, {type: 'audio/ogg'});
                if(dataConn && dataConn.open) {
                    dataConn.send({file: audioBlob, name: "voice.ogg", type: "audio"});
                    statusMsg.innerText = "ভয়েস পাঠানো হয়েছে!";
                } else {
                    alert("আগে কল দিয়ে কানেক্ট করুন!");
                }
                audioChunks = [];
            };
        }).catch(err => statusMsg.innerText = "ক্যামেরা পারমিশন দিন!");

        peer.on('open', id => myIdEl.innerText = "আপনার ID: " + id);

        // ভয়েস বাটন কন্ট্রোল (Android ও KaiOS এর জন্য)
        const startRec = (e) => { e.preventDefault(); voiceBtn.innerText = "রেকর্ড হচ্ছে..."; audioChunks = []; mediaRecorder.start(); };
        const stopRec = (e) => { e.preventDefault(); voiceBtn.innerText = "ভয়েস রেকর্ড (টিপে ধরুন)"; mediaRecorder.stop(); };

        voiceBtn.addEventListener('mousedown', startRec);
        voiceBtn.addEventListener('mouseup', stopRec);
        voiceBtn.addEventListener('touchstart', startRec);
        voiceBtn.addEventListener('touchend', stopRec);

        // কল রিসিভ করা
        peer.on('call', call => {
            if(confirm("ইনকামিং কল! রিসিভ করবেন?")) {
                currentCall = call;
                call.answer(localStream);
                call.on('stream', s => remoteV.srcObject = s);
            }
        });

        // ডাটা ও ফাইল রিসিভ করা
        peer.on('connection', conn => {
            dataConn = conn;
            conn.on('data', d => {
                const url = URL.createObjectURL(new Blob([d.file]));
                if(d.type === "audio") {
                    new Audio(url).play();
                    statusMsg.innerText = "নতুন ভয়েস মেসেজ এসেছে!";
                } else {
                    statusMsg.innerHTML = `<a href="${url}" download="${d.name}" style="color:#0f0">ফাইল ডাউনলোড করুন</a>`;
                    alert("একটি ফাইল এসেছে!");
                }
            });
        });

        function makeCall() {
            const id = document.getElementById('target-id').value;
            if(!id) return alert("আইডি দিন");
            statusMsg.innerText = "কানেক্ট হচ্ছে...";
            dataConn = peer.connect(id);
            currentCall = peer.call(id, localStream);
            currentCall.on('stream', s => remoteV.srcObject = s);
        }

        function endCall() {
            location.reload(); 
        }

        function sendFile(f) {
            if(!dataConn || !dataConn.open) return alert("আগে কল কানেক্ট করুন");
            dataConn.send({file: f, name: f.name, type: "file"});
            statusMsg.innerText = "ফাইল পাঠানো সফল!";
        }
    </script>
</body>
</html>
