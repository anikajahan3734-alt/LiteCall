<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; text-align: center; font-family: sans-serif; overflow: hidden; }
        .v-container { position: fixed; width: 100vw; height: 100vh; top: 0; left: 0; background: #111; }
        #remote-v { width: 100%; height: 100%; object-fit: contain; }
        #ui-box { position: fixed; bottom: 10px; width: 90%; left: 5%; z-index: 10; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 20px; transition: 0.5s; }
        .btn { padding: 12px; margin: 5px; border-radius: 10px; border: none; font-weight: bold; color: white; width: 45%; font-size: 14px; }
        .v-msg-btn { background: #ffc107; color: black; width: 92%; }
        .file-btn { background: #007bff; }
        .call-btn { background: #28a745; }
        .end-btn { background: #dc3545; width: 92%; }
        input { padding: 12px; width: 85%; margin-bottom: 10px; border-radius: 8px; border: none; text-align: center; font-size: 20px; font-weight: bold; }
        .hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
        #status-msg { color: #0f0; font-size: 12px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="v-container" onclick="toggleUI()">
        <video id="remote-v" autoplay playsinline controls></video>
    </div>
    <div id="ui-box">
        <div id="status-msg">সিস্টেম রেডি...</div>
        <div id="my-id" style="color:yellow; font-weight:bold; font-size: 22px; margin-bottom:8px;">আপনার আইডি: 1</div>
        <input type="number" id="target-id" placeholder="বন্ধুর ছোট আইডি (যেমন: 2)">
        <button class="btn v-msg-btn" id="voiceBtn">ভয়েস মেসেজ (চেপে ধরুন)</button>
        <button class="btn file-btn" onclick="sendVideoFile()">ভিডিও পাঠান</button>
        <button class="btn call-btn" onclick="makeCall()">লাইভ কল</button>
        <button class="btn end-btn" onclick="location.reload()">রিলোড</button>
    </div>

    <script>
        // এখানে আইডি '1' ফিক্সড করে দেওয়া হয়েছে
        const myId = "1"; 
        const peer = new Peer(myId);
        let localStream;
        let mediaRec;
        let audioChunks = [];

        navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(s => { localStream = s; });

        function sendVideoFile() {
            const tid = document.getElementById('target-id').value;
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'video/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const conn = peer.connect(tid);
                conn.on('open', () => {
                    conn.send({ type: 'video', file: file, mime: file.type });
                    document.getElementById('status-msg').innerText = "ভিডিও পাঠানো হয়েছে!";
                });
            };
            input.click();
        }

        const vBtn = document.getElementById('voiceBtn');
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            mediaRec = new MediaRecorder(s);
            mediaRec.ondataavailable = e => audioChunks.push(e.data);
            mediaRec.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/mp3' });
                const tid = document.getElementById('target-id').value;
                const conn = peer.connect(tid);
                conn.on('open', () => {
                    conn.send({ type: 'voice', file: blob });
                    document.getElementById('status-msg').innerText = "ভয়েস পাঠানো হয়েছে!";
                });
                audioChunks = [];
            };
        });
        vBtn.onmousedown = () => { mediaRec.start(); vBtn.innerText = "রেকর্ড হচ্ছে..."; };
        vBtn.onmouseup = () => { mediaRec.stop(); vBtn.innerText = "ভয়েস মেসেজ (চেপে ধরুন)"; };

        peer.on('connection', conn => {
            conn.on('data', data => {
                const blob = new Blob([data.file], { type: data.mime || 'audio/mp3' });
                const url = URL.createObjectURL(blob);
                document.getElementById('remote-v').src = url;
                document.getElementById('remote-v').play();
                document.getElementById('ui-box').classList.add('hidden');
            });
        });

        peer.on('call', call => {
            call.answer(localStream);
            call.on('stream', st => { 
                document.getElementById('remote-v').srcObject = st;
                document.getElementById('ui-box').classList.add('hidden');
            });
        });

        function makeCall() {
            const tid = document.getElementById('target-id').value;
            const call = peer.call(tid, localStream);
            call.on('stream', st => { 
                document.getElementById('remote-v').srcObject = st;
                document.getElementById('ui-box').classList.add('hidden');
            });
        }

        function toggleUI() { document.getElementById('ui-box').classList.toggle('hidden'); }
    </script>
</body>
</html>
