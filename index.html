<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; text-align: center; font-family: sans-serif; }
        #remote-v { width: 100%; height: 160px; background: #111; object-fit: contain; }
        #ui-box { padding: 10px; background: #111; }
        .btn { padding: 12px; margin: 4px; border-radius: 8px; border: none; font-weight: bold; color: white; width: 46%; font-size: 13px; }
        .v-msg-btn { background: #ffc107; color: black; width: 94%; margin-bottom: 10px; }
        .file-btn { background: #007bff; }
        .call-btn { background: #28a745; }
        .reload-btn { background: #dc3545; width: 94%; margin-top: 10px; }
        input { padding: 12px; width: 88%; margin: 10px 0; border-radius: 6px; border: none; text-align: center; font-size: 20px; font-weight: bold; background: #fff; color: #000; }
        #my-id-display { font-size: 16px; color: yellow; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
    <video id="remote-v" autoplay playsinline controls></video>
    <div id="ui-box">
        <div id="my-id-display">আপনার আইডি লোড হচ্ছে...</div>
        <input type="number" id="tid" placeholder="বন্ধুর আইডি দিন">
        <button class="btn v-msg-btn" id="vBtn">ভয়েস মেসেজ (চেপে ধরুন)</button>
        <button class="btn file-btn" onclick="sendV()">ভিডিও পাঠান</button>
        <button class="btn call-btn" onclick="makeC()">লাইভ কল</button>
        <button class="btn reload-btn" onclick="location.reload()">রিলোড</button>
    </div>

    <script>
        // অটোমেটিক আলাদা আইডি সেট করার লজিক
        let myId = localStorage.getItem('lite_call_id');
        if (!myId) {
            myId = Math.floor(1 + Math.random() * 9).toString(); // ১ থেকে ৯ এর মধ্যে যেকোনো একটি ছোট সংখ্যা
            localStorage.setItem('lite_call_id', myId);
        }
        document.getElementById('my-id-display').innerText = "আপনার আইডি: " + myId;

        const peer = new Peer(myId);
        let stream;
        let rec;
        let chunks = [];

        navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(s => { stream = s; });

        function sendV() {
            const tid = document.getElementById('tid').value;
            const inp = document.createElement('input');
            inp.type = 'file'; inp.accept = 'video/*';
            inp.onchange = e => {
                const conn = peer.connect(tid);
                conn.on('open', () => conn.send({ type: 'vid', file: e.target.files[0], mime: e.target.files[0].type }));
            };
            inp.click();
        }

        const vBtn = document.getElementById('vBtn');
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            rec = new MediaRecorder(s);
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = () => {
                const conn = peer.connect(document.getElementById('tid').value);
                conn.on('open', () => conn.send({ type: 'voice', file: new Blob(chunks) }));
                chunks = [];
            };
        });
        vBtn.onmousedown = () => { rec.start(); vBtn.innerText = "রেকর্ড হচ্ছে..."; };
        vBtn.onmouseup = () => { rec.stop(); vBtn.innerText = "ভয়েস মেসেজ (চেপে ধরুন)"; };

        peer.on('connection', conn => {
            conn.on('data', data => {
                const blob = new Blob([data.file], { type: data.mime || 'audio/mp3' });
                document.getElementById('remote-v').src = URL.createObjectURL(blob);
                document.getElementById('remote-v').play();
            });
        });

        peer.on('call', call => {
            call.answer(stream);
            call.on('stream', s => { document.getElementById('remote-v').srcObject = s; });
        });

        function makeC() {
            const call = peer.call(document.getElementById('tid').value, stream);
            call.on('stream', s => { document.getElementById('remote-v').srcObject = s; });
        }
    </script>
</body>
</html>
