<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; text-align: center; font-family: sans-serif; }
        #remote-v { width: 100%; height: 140px; background: #111; object-fit: contain; }
        #ui-box { padding: 8px; background: #111; }
        .btn { padding: 10px; margin: 3px; border-radius: 5px; border: none; font-weight: bold; color: white; width: 45%; font-size: 12px; }
        .v-msg-btn { background: #ffc107; color: black; width: 92%; margin-bottom: 8px; }
        .file-btn { background: #007bff; }
        .call-btn { background: #28a745; }
        .reload-btn { background: #dc3545; width: 92%; margin-top: 8px; }
        input { padding: 10px; width: 85%; margin: 8px 0; border-radius: 5px; border: none; text-align: center; font-size: 18px; font-weight: bold; background: #fff; color: #000; }
        #id-info { font-size: 14px; color: yellow; font-weight: bold; }
    </style>
</head>
<body>
    <video id="remote-v" autoplay playsinline controls></video>
    <div id="ui-box">
        <div id="id-info">আপনার আইডি: 1</div>
        <input type="number" id="tid" placeholder="বন্ধুর আইডি">
        <button class="btn v-msg-btn" id="vBtn">ভয়েস মেসেজ (চেপে ধরুন)</button>
        <button class="btn file-btn" onclick="sendV()">ভিডিও পাঠান</button>
        <button class="btn call-btn" onclick="makeC()">লাইভ কল</button>
        <button class="btn reload-btn" onclick="location.reload()">রিলোড</button>
    </div>
    <script>
        const myId = "1"; 
        const peer = new Peer(myId);
        let stream;
        let rec;
        let chunks = [];

        navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(s => { stream = s; });

        function sendV() {
            const tid = document.getElementById('tid').value;
            const inp = document.createElement('input');
            inp.type = 'file'; inp.accept = 'video/*';
            inp.onchange = e => {
                const conn = peer.connect(tid);
                conn.on('open', () => conn.send({ type: 'vid', file: e.target.files[0], mime: e.target.files[0].type }));
            };
            inp.click();
        }

        const vBtn = document.getElementById('vBtn');
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            rec = new MediaRecorder(s);
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = () => {
                const conn = peer.connect(document.getElementById('tid').value);
                conn.on('open', () => conn.send({ type: 'voice', file: new Blob(chunks) }));
                chunks = [];
            };
        });
        vBtn.onmousedown = () => { rec.start(); vBtn.innerText = "রেকর্ড..."; };
        vBtn.onmouseup = () => { rec.stop(); vBtn.innerText = "ভয়েস মেসেজ (চেপে ধরুন)"; };

        peer.on('connection', conn => {
            conn.on('data', data => {
                document.getElementById('remote-v').src = URL.createObjectURL(new Blob([data.file], { type: data.mime || 'audio/mp3' }));
                document.getElementById('remote-v').play();
            });
        });

        peer.on('call', call => {
            call.answer(stream);
            call.on('stream', s => { document.getElementById('remote-v').srcObject = s; });
        });

        function makeC() {
            const call = peer.call(document.getElementById('tid').value, stream);
            call.on('stream', s => { document.getElementById('remote-v').srcObject = s; });
        }
    </script>
</body>
</html>
